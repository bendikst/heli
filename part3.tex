\section{Results and Figures}\label{sec:figures}
Answer all the parts of the exercise in an organized and clear manner. You should of course try to get good results in all the exercises, but if you have made a good effort without achieving great performance, a good discussion of possible reasons is just as good. Present your thinking and efforts and discuss possible reasons for good or bad results.

Include plots and/or tables of all relevant results, but make sure you don't overwhelm the reader with too many plots. Have a clear plan about what you want to communicate with a specific plot/figure, and use appropriate labels and comments. Keep in mind that the plots should be as ``readable'' as possible; that is, they should not be too hard to interpret and be reasonably self contained.

There are some important things to consider when exporting figures from MATLAB, most importantly which format you use. Never ever use JPEG for anything that is not a photography or similar. Any figure, like a plot or block diagram, must never be stored as a JPEG\@. If you zoom in on \Cref{fig:constraint_jpg} you can see a lot of noise close to any of the dark curves and lines, this is due to the compression in JPEG\@. \Cref{fig:constraint_jpg} will look horrible both on a screen and on paper.

The PNG format is slightly better for plots, but since it is a raster format (a grid of pixels), it looks ugly if you zoom in. It also looks ugly if you scale it, both on a screen and on paper. Try to avoid PNG if you can. \Cref{fig:constraint_png,fig:constraint_png_large} are both PNG figures; the latter being a larger figure scaled more than the former. Note both how choppy and ugly the blue curve is, and how the different sizes create inconsistent font sizes.

The simplest way to get a reasonably good looking plot is to save it as EPS in MATLAB\@. Do this by clicking ``File'' in the figure window, and the ``Save As\ldots''; choose ``EPS file (*.eps)'' in the ``Save as type:'' menu.\footnote{pdfLatex does not support EPS directly, but since we have loaded the \emph{epstodf} package, this is not a problem.} \Cref{fig:constraint_eps} shows a plot in EPS format. Since EPS is a vector format, the Figure can be scaled and still look good (but mind the font size!). If you zoom in you can see that the curve and the letters/numbers are smooth. A figure in vector format will usually look good both on a screen and on paper.

Note that the size of the actual figure window in MATLAB determines how large the exported figure is. Hence, if you enlarge the figure window before exporting, you will need to scale the figure by a larger factor in the report. This will lead to a tiny font in the figure. There are many better ways of exporting graphics from MATLAB, but they quickly become fairly involved. The above method of exporting to EPS will in most cases give nice figures.

You can write Latex in your MATLAB figures. The script used to create \Cref{fig:constraint_jpg,fig:constraint_eps} is included in \Cref{sec:plot_constraint_m}. Do not use a screen shot of a scope of figure in MATLAB in your report.

\begin{figure}[htb]
	\centering
		\includegraphics[width=0.8\textwidth]{figures/constraint_jpg.jpg}
	\caption{A plot in JPEG format --- a very bad idea.}
\label{fig:constraint_jpg}
\end{figure}

\begin{figure}[htb]
	\centering
		\includegraphics[width=0.8\textwidth]{figures/constraint_png.png}
	\caption{A plot in PNG format --- a bad idea.}
\label{fig:constraint_png}
\end{figure}

\begin{figure}[htb]
	\centering
		\includegraphics[width=0.8\textwidth]{figures/constraint_png_large.png}
	\caption{A plot in PNG format --- a bad idea. This figure is originally larger than the other PNG figure, but both are scaled to the same size.}
\label{fig:constraint_png_large}
\end{figure}



Remember to reference all figures in the text. Figures have a number and should be referenced by that number (again, always use dynamic references). They also tend to float around, meaning they generally don't appear where you ask them to in the text. This is fine, do not try to force a figure (or a table) to appear in a particular place. As long a you refer to it, it's easy to find. No figure should be included without being referenced in the text.

If you look at the source code for including figures, you can see that the optional option \verb+[htb]+ has been used. This tells Latex where you wish the figure to appear, in prioritized order. \verb+h+ means ``Here'', t means ``Top of this page'', b means ``Bottom of this page'', and p (not used here) means ``on a Page with only floats (such as figures and tables)''. Note that your wish might not be granted, and this is because Latex actually optimizes the placement of figures. If you start forcing figures to be in specific places, it often leads to really strange layout somewhere else in the document. 

Generally, let Latex handle the documentation layout. This is one of the main reasons to choose Latex over software such as Microsoft Word.

\subsection{Results and Discussion}
All problems should have their own discussion of results. 

Remember: all plots and results need a description, explanation, and discussion.


\section{Part III - Multivariable control}\label{sec:part3}
\subsection{Problem 1}
We put the system in a state-space formulation on the form:
\begin{gather*}
    \mathbf{\dot{x}} = \mathbf{Ax} + \mathbf{Bu}
\end{gather*}
where A and B are matrices, and our state and input vector are: 
\begin{gather*}
    \mathbf{x} = 
    \begin{bmatrix}
        \tilde{p}\\\tilde{\dot{p}}\\\tilde{\dot{e}}
        \end{bmatrix}
     \text{  and  } \mathbf{u} = 
    \begin{bmatrix} \tilde{V_s}\\\tilde{V_d} \end{bmatrix}
\end{gather*}
This gives us the following state-space model:
\begin{gather*}
     \begin{bmatrix}
        \tilde{\dot{p}}\\\tilde{\ddot{p}}\\\tilde{\ddot{e}}
    \end{bmatrix}
    \text{ + } \begin{bmatrix}
        0 & 1 & 0 \\
        0 & 0 & 0 \\
        0 & 0 & 0 \\ \end{bmatrix}
    \begin{bmatrix}
        \tilde{p}\\\tilde{\dot{p}}\\\tilde{\dot{e}}
    \end{bmatrix}
    \text{ = } \begin{bmatrix}
        0 & 0 \\
        0 & K_1 \\
        K_2 & 0 \\
    \end{bmatrix}
    \begin{bmatrix} \tilde{V_s}\\\tilde{V_d} \end{bmatrix}
\end{gather*}

\subsection{Problem 2}
We now aim to track the reference $\mathbf{r}
= \begin{bmatrix} \tilde{p_c,} & \tilde{\dot{e_c}}
\end{bmatrix}^T$ for the pitch angle $\tilde{p}$ and elevation rate $\dot{\tilde{e}}$. The reference values $\tilde{p}_c$ and $\dot{\tilde{e}}_c$ are given by the joystick, the x-axis and y-axis respectively. Firstly, we examine if the system is controllable. The controllability matrix is given by:
\begin{gather*}
    \mathcal{C} = 
    \begin{bmatrix} \mathbf{B} & \mathbf{AB} &
    \mathbf{A^2B} \end{bmatrix}
    = \begin{bmatrix}
    0 & 0 & 0 & K_1 & 0 & 0 \\
    0 & K_1 & 0 & 0 & 0 & 0 \\
    K_2 & 0 & 0 & 0 & 0 & 0
    \end{bmatrix}
\end{gather*}
We see that $\mathcal{C}$ has full rank, which means that the system is controllable. In order to actually control the system, we implement a controller of the form:
\begin{gather*}
    \mathbf{u} = \mathbf{Pr} - \mathbf{Kx}
\end{gather*}
In the controller, $\mathbf{r}$ is the reference given by the joystick output. The matrix $\mathbf{K}$ corresponds to the linear quadraric regulator (LQR) for which the control input $\mathbf{u} = -\mathbf{Kx}$ optimizes the cost function
\begin{gather*}
    \mathit{J} = \int_{0}^{\infty}(\mathbf{x}^T(t)
    \mathbf{Qx}(t) + \mathbf{u}^T(t)\mathbf{Ru}(t))
    \mathit{dt}
\end{gather*}
The matrix $\mathbf{K}$ is obtained by using the MATLAB command K = lqr(A,B,Q,R), where $\mathbf{Q}$ and $\mathbf{R}$ are weighting matrices. For simplicity, $\mathbf{Q}$ and $\mathbf{R}$ are diagonal. When deciding their elements we started with an initial guess, and tuned from there. We looked for values making the helicopter fast and accurate, and ended up with the following:
\begin{gather*}
    \mathbf{Q} = \begin{bmatrix}
    91.2 & 0 & 0 \\ 
    0 & 50 & 0 \\
    0 & 0 & 100 \end{bmatrix}\textbf{, } \mathbf{R} = \begin{bmatrix} 1 & 0 \\ 0 & 1 \end{bmatrix}
\end{gather*}
Our state-space model with the controller is
\begin{gather*}
     \mathbf{\dot{x}} = \mathbf{Ax} + \mathbf{B}(\mathbf{Pr} - \mathbf{Kx})
\end{gather*}
We want to obtain a solution such that  \( \mathbf{y}(t) \rightarrow \mathbf{r} \)  as t \(\rightarrow \infty\). When the output gets stable,  
\(\mathbf{\dot{x}} \rightarrow 0\). We get:
\begin{gather*}
    0 = \mathbf{Ax_\infty} + \mathbf{B}(\mathbf{Pr} - \mathbf{Kx_\infty)} \\
    (\mathbf{A} - \mathbf{BK})\mathbf{x_\infty} = -\mathbf{BPr} \\
    \mathbf{x_\infty} = (\mathbf{BK} - \mathbf{A})^{-1}
    \mathbf{BPr}
\end{gather*}
Substituting this into \(\mathbf{y_\infty} = \mathbf{Cx_\infty}\) yields:      
\begin{gather*}
    \mathbf{y_\infty} = 
    \begin{bmatrix} \mathbf{C}(\mathbf{BK} - \mathbf{A})^{-1} \mathbf{B}\end{bmatrix}\mathbf{Pr}
\end{gather*}
which gives:
\begin{gather*}
    \mathbf{P} = 
    \begin{bmatrix}\mathbf{C}(\mathbf{BK} - \mathbf{A})^{-1}\mathbf{B}\end{bmatrix}^{-1}
\end{gather*}
Our \textbf{K} and \textbf{P}:
\begin{gather*}
    \mathbf{K} = \begin{bmatrix}
    0 & 0 & 10 \\
    9.5499 & 9.0841 & 0 \end{bmatrix}\textbf{, } \mathbf{P} =
    \begin{bmatrix} 0 & 10 \\ 9.5499 & 0 \end{bmatrix}
\end{gather*}

KOMMENTERE KONTROLLERVALG

\subsection{Problem 3}
We now modify the controller to include an integral effect for the elevation rate and the pitch angle. Including an integral effect makes our controller a PI controller, and results in two additional states. We call the new states $\gamma$ and $\zeta$, and their differential equations are given by:
\begin{gather*}
    \dot{\gamma} = \tilde{p} - \tilde{p_c}\\
    \dot{\zeta} = \dot{\tilde{e}} - \dot{\tilde{e_c}}
\end{gather*}
The state vector and the input vector are now given by:
\begin{gather*}
    \mathbf{x} = \begin{bmatrix}
    \tilde{p} \\ \tilde{\dot{p}} \\
    \dot{\tilde{e}} \\ \gamma \\ \zeta \end{bmatrix}
    \text{ and } \mathbf{u} = \begin{bmatrix}
    \tilde{V_s} \\ \tilde{V_d} \end{bmatrix}
\end{gather*}

HER MÅ VI HA PLOTS HVOR VI SAMMENLIGNER HELIKOPTERETS RESPONS MED OG UTEN INTEGRALEFFEKT. EVT. NYE Q,R OG K MED FORKLARING. 









